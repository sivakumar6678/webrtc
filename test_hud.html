<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HUD Metrics Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #222;
            color: white;
            font-family: Arial, sans-serif;
        }
        
        .video-container {
            position: relative;
            width: 640px;
            height: 480px;
            background: #000;
            margin: 20px auto;
            border: 2px solid #333;
        }
        
        .hud {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
            min-width: 200px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
        }
        
        .hud-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 4px;
        }
        
        .hud-title {
            font-weight: bold;
            color: #00ff00;
        }
        
        .hud-close {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 4px;
        }
        
        .metric-row {
            margin-bottom: 6px;
        }
        
        .metric-label {
            font-weight: bold;
        }
        
        .metric-details {
            font-size: 12px;
            margin-left: 8px;
        }
        
        .hud-footer {
            font-size: 10px;
            color: #888;
            margin-top: 8px;
            padding-top: 4px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .fps-good { color: #00ff00; }
        .fps-bad { color: #ff4444; }
        .latency { color: #ffff00; }
        .bandwidth { color: #00ffff; }
        
        .controls {
            text-align: center;
            margin: 20px;
        }
        
        button {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #444;
        }
    </style>
</head>
<body>
    <h1>Phase 5: HUD Metrics Test</h1>
    
    <div class="video-container">
        <!-- Simulated video background -->
        <div style="width: 100%; height: 100%; background: linear-gradient(45deg, #333, #666); display: flex; align-items: center; justify-content: center;">
            <span style="color: #888; font-size: 18px;">üìπ Simulated Video Stream</span>
        </div>
        
        <!-- HUD Overlay -->
        <div class="hud" id="hud">
            <div class="hud-header">
                <span class="hud-title">üìä LIVE METRICS</span>
                <button class="hud-close" onclick="toggleHUD()">‚úï</button>
            </div>
            
            <div class="metric-row">
                <span class="metric-label fps-good" id="fps-display">FPS: 0</span>
                <span id="fps-warning" style="color: #ff4444; margin-left: 8px; display: none;">‚ö†Ô∏è LOW FPS</span>
            </div>
            
            <div class="metric-row">
                <div class="metric-label latency">Latency:</div>
                <div class="metric-details">
                    <div>p50: <span id="latency-p50">0.0ms</span></div>
                    <div>p95: <span id="latency-p95">0.0ms</span></div>
                </div>
            </div>
            
            <div class="metric-row">
                <div class="metric-label bandwidth">Bandwidth:</div>
                <div class="metric-details">
                    <div>‚Üì <span id="bandwidth-down">0 kbps</span></div>
                    <div>‚Üë <span id="bandwidth-up">0 kbps</span></div>
                </div>
            </div>
            
            <div class="hud-footer">
                Ctrl+H to toggle ‚Ä¢ Updates every 1s
            </div>
        </div>
    </div>
    
    <div class="controls">
        <button onclick="startSimulation()">Start Metrics Simulation</button>
        <button onclick="stopSimulation()">Stop Simulation</button>
        <button onclick="toggleHUD()">Toggle HUD</button>
        <button onclick="exportMetrics()">Export Metrics</button>
    </div>
    
    <div id="console-log" style="background: #111; padding: 15px; margin: 20px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
        <strong>Console Log (updates every 5s):</strong><br>
        <div id="log-content">Waiting for simulation to start...</div>
    </div>

    <script>
        // Metrics Tracker Implementation
        class MetricsTracker {
            constructor() {
                this.maxSamples = 30;
                
                // FPS tracking
                this.fpsHistory = [];
                this.lastFpsTime = performance.now();
                this.fpsFrameCount = 0;
                
                // Latency tracking
                this.latencyHistory = [];
                
                // Bandwidth tracking
                this.bandwidthHistory = [];
                this.lastBandwidthCheck = performance.now();
                
                // Current values
                this.currentFps = 0;
                this.currentLatency = { median: 0, p95: 0 };
                this.currentBandwidth = { uplink: 0, downlink: 0 };
                
                // Console logging
                this.lastConsoleLog = performance.now();
                this.consoleLogInterval = 5000;
            }
            
            updateFPS() {
                this.fpsFrameCount++;
                const now = performance.now();
                const elapsed = now - this.lastFpsTime;
                
                if (elapsed >= 1000) {
                    const fps = Math.round((this.fpsFrameCount * 1000) / elapsed);
                    
                    this.fpsHistory.push(fps);
                    if (this.fpsHistory.length > this.maxSamples) {
                        this.fpsHistory.shift();
                    }
                    
                    this.currentFps = this.calculateMovingAverage(this.fpsHistory);
                    this.fpsFrameCount = 0;
                    this.lastFpsTime = now;
                }
            }
            
            addLatency(latencyMs) {
                this.latencyHistory.push(latencyMs);
                if (this.latencyHistory.length > this.maxSamples) {
                    this.latencyHistory.shift();
                }
                
                if (this.latencyHistory.length > 0) {
                    const sorted = [...this.latencyHistory].sort((a, b) => a - b);
                    const median = this.calculatePercentile(sorted, 50);
                    const p95 = this.calculatePercentile(sorted, 95);
                    
                    this.currentLatency = { median, p95 };
                }
            }
            
            updateBandwidth(uplink, downlink) {
                this.bandwidthHistory.push({ uplink, downlink });
                if (this.bandwidthHistory.length > this.maxSamples) {
                    this.bandwidthHistory.shift();
                }
                
                if (this.bandwidthHistory.length > 0) {
                    const avgUplink = this.calculateMovingAverage(this.bandwidthHistory.map(b => b.uplink));
                    const avgDownlink = this.calculateMovingAverage(this.bandwidthHistory.map(b => b.downlink));
                    
                    this.currentBandwidth = { uplink: avgUplink, downlink: avgDownlink };
                }
            }
            
            getMetrics() {
                return {
                    fps: this.currentFps,
                    latency: this.currentLatency,
                    bandwidth: this.currentBandwidth,
                    isLowFps: this.currentFps < 1
                };
            }
            
            logMetrics() {
                const now = performance.now();
                if (now - this.lastConsoleLog >= this.consoleLogInterval) {
                    const metrics = this.getMetrics();
                    
                    const logMessage = `[HUD Metrics] FPS: ${metrics.fps}, Latency: ${metrics.latency.median.toFixed(1)}ms (p95: ${metrics.latency.p95.toFixed(1)}ms), Bandwidth: ‚Üì${metrics.bandwidth.downlink}kbps ‚Üë${metrics.bandwidth.uplink}kbps`;
                    
                    console.log(logMessage);
                    
                    // Update console log display
                    const logContent = document.getElementById('log-content');
                    const timestamp = new Date().toLocaleTimeString();
                    logContent.innerHTML += `<br>[${timestamp}] ${logMessage}`;
                    logContent.scrollTop = logContent.scrollHeight;
                    
                    this.lastConsoleLog = now;
                }
            }
            
            calculateMovingAverage(values) {
                if (values.length === 0) return 0;
                const sum = values.reduce((acc, val) => acc + val, 0);
                return Math.round(sum / values.length);
            }
            
            calculatePercentile(sortedValues, percentile) {
                if (sortedValues.length === 0) return 0;
                
                const index = (percentile / 100) * (sortedValues.length - 1);
                const lower = Math.floor(index);
                const upper = Math.ceil(index);
                
                if (lower === upper) {
                    return sortedValues[lower];
                }
                
                const weight = index - lower;
                return sortedValues[lower] * (1 - weight) + sortedValues[upper] * weight;
            }
            
            exportMetrics() {
                return {
                    timestamp: new Date().toISOString(),
                    fps: {
                        current: this.currentFps,
                        history: [...this.fpsHistory]
                    },
                    latency: {
                        current: this.currentLatency,
                        history: [...this.latencyHistory]
                    },
                    bandwidth: {
                        current: this.currentBandwidth,
                        history: [...this.bandwidthHistory]
                    }
                };
            }
        }
        
        // Global instances
        const metricsTracker = new MetricsTracker();
        let simulationInterval = null;
        let hudUpdateInterval = null;
        let isHudVisible = true;
        
        // Simulation functions
        function startSimulation() {
            if (simulationInterval) return;
            
            console.log('[HUD Test] Starting metrics simulation...');
            
            // Simulate detection frames and latency
            simulationInterval = setInterval(() => {
                // Simulate FPS
                metricsTracker.updateFPS();
                
                // Simulate random latency (10-50ms)
                const latency = 10 + Math.random() * 40;
                metricsTracker.addLatency(latency);
                
                // Simulate bandwidth (100-1000 kbps)
                const downlink = Math.round(100 + Math.random() * 900);
                const uplink = Math.round(10 + Math.random() * 90);
                metricsTracker.updateBandwidth(uplink, downlink);
                
            }, 50); // 20 FPS simulation
            
            // Start HUD updates
            hudUpdateInterval = setInterval(() => {
                updateHUD();
                metricsTracker.logMetrics();
            }, 1000);
            
            document.getElementById('log-content').innerHTML = 'Simulation started...';
        }
        
        function stopSimulation() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            if (hudUpdateInterval) {
                clearInterval(hudUpdateInterval);
                hudUpdateInterval = null;
            }
            console.log('[HUD Test] Simulation stopped');
        }
        
        function updateHUD() {
            const metrics = metricsTracker.getMetrics();
            
            // Update FPS
            const fpsDisplay = document.getElementById('fps-display');
            const fpsWarning = document.getElementById('fps-warning');
            
            fpsDisplay.textContent = `FPS: ${metrics.fps}`;
            fpsDisplay.className = `metric-label ${metrics.isLowFps ? 'fps-bad' : 'fps-good'}`;
            fpsWarning.style.display = metrics.isLowFps ? 'inline' : 'none';
            
            // Update latency
            document.getElementById('latency-p50').textContent = `${metrics.latency.median.toFixed(1)}ms`;
            document.getElementById('latency-p95').textContent = `${metrics.latency.p95.toFixed(1)}ms`;
            
            // Update bandwidth
            document.getElementById('bandwidth-down').textContent = `${metrics.bandwidth.downlink} kbps`;
            document.getElementById('bandwidth-up').textContent = `${metrics.bandwidth.uplink} kbps`;
        }
        
        function toggleHUD() {
            const hud = document.getElementById('hud');
            isHudVisible = !isHudVisible;
            hud.style.display = isHudVisible ? 'block' : 'none';
        }
        
        function exportMetrics() {
            const metrics = metricsTracker.exportMetrics();
            console.log('[HUD Test] Exported metrics:', metrics);
            
            // Create downloadable JSON
            const blob = new Blob([JSON.stringify(metrics, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hud-metrics-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'h') {
                e.preventDefault();
                toggleHUD();
            }
        });
        
        // Auto-start simulation for demo
        setTimeout(startSimulation, 1000);
    </script>
</body>
</html>